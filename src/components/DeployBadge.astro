---
import site from "@/site.json";
---

<div id="deploy-badge" class="success"></div>

<script is:inline data-repo={site.githubRepo}>
  const repo = document.currentScript.dataset.repo;
  let user = JSON.parse(localStorage.getItem("decap-cms-user"));

  async function getLatestSha() {
    const response = await fetch(
      `https://api.github.com/repos/${repo}/git/refs/heads/main`,
      {
        headers: {
          authorization: `token ${user.token}`,
        },
      }
    );
    const ref = await response.json();
    return ref.object.sha;
  }

  async function getLatestDeployment() {
    const response = await fetch(
      `https://api.github.com/repos/${repo}/deployments`,
      {
        cache: "no-cache",
        headers: {
          authorization: `token ${user.token}`,
        },
      }
    );
    const deployments = await response.json();
    return deployments[0];
  }

  async function getStatus(deployment) {
    const response = await fetch(deployment.statuses_url, {
      cache: "no-cache",
      headers: {
        authorization: `token ${user.token}`,
      },
    });
    const statuses = await response.json();
    return statuses[0];
  }

  async function updateBadge() {
    const badge = document.querySelector("#deploy-badge");

    console.log("updating badge...");

    const sha = await getLatestSha();
    const deployment = await getLatestDeployment();
    const status = await getStatus(deployment);
    console.log({ deployment, status });

    // Check if the deployment is the latest
    if (sha !== deployment.sha) {
      status.state = "pending";
    }

    const trans = {
      success: "OK",
      failure: "error",
      pending: "pendiente...",
    };

    badge.innerHTML = `
      <a href="#" onclick="updateBadge()">
        <span title="${new Date(deployment.updated_at).toLocaleString()}" style="color: white">build: ${trans[status.state]}</span>
      </a>
    `;

    switch (status.state) {
      case "success":
        badge.style.background = "green";
        break;
      case "failure":
        badge.style.background = "red";
        break;
      case "pending":
        badge.style.background = "orange";
        setTimeout(updateBadge, 1000 * 5);
        break;
      default:
        console.error("unknown status", status.state);
        break;
    }
  }

  function init() {
    // local CMS
    if (user.backendName !== "github") return;

    CMS.registerEventListener({
      name: "postPublish",
      handler: () => {
        console.log("postPublish event triggered");
        updateBadge();
      },
    });

    updateBadge();
  }

  document.addEventListener("DOMContentLoaded", init);

  setInterval(() => {
    const newUser = JSON.parse(localStorage.getItem("decap-cms-user"));
    if (user?.token !== newUser.token) {
      console.log("user changed:", newUser);
      user = newUser;
      init();
    }
  }, 1000);
</script>

<style>
  #deploy-badge {
    position: fixed;
    bottom: 0;
    right: 0;
    padding: 0.5em;
    z-index: 10000;
    color: white;
  }
</style>
